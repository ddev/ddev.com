---
/**
 * A single card used to represent a blog post. Should probably be placed in a flex grid.
 */
import type { CollectionEntry } from "astro:content"
import { render } from "astro:content"
import { Picture } from 'astro:assets'
import type { ImageMetadata } from 'astro'
interface Props {
  post: CollectionEntry<"blog">
}

import { getEntry } from "astro:content"
import { getSlug, formatDate, getCategoryUrl } from "../lib/api"

const { post } = Astro.props
const { remarkPluginFrontmatter } = await render(post)

const author = await getEntry("authors", getSlug(post.data.author))
const authorImage = author?.data.avatarUrl ?? null

const featureImage = post.data.featureImage

const featureImageUrl = featureImage?.src ?? `/img/generic-thumbnail.png`
const featureImageAlt = featureImage?.alt ?? ``
const featureImageDarkUrl = featureImage?.srcDark ?? null

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/public/img/**/*.{png,jpg,jpeg,webp,gif}'
)
const resolveImage = async (path: string) => {
  const key = `/public${path}`
  return images[key] ? (await images[key]()).default : path
}
const resolvedSrc = await resolveImage(featureImageUrl)
const resolvedSrcDark = featureImageDarkUrl ? await resolveImage(featureImageDarkUrl) : null

const categories = post.data.categories.length ? post.data.categories : []
---

{
  /* `isolation: isolate` is here to convince Safari not to display un-rounded corners during animation */
}
<div
  class="relative flex flex-col rounded-lg overflow-hidden"
  style="isolation: isolate;"
>
  <div class="shrink-0">
    {
      featureImageUrl.includes(".svg") ? (
        <>
          <img src={featureImageUrl} alt={featureImageAlt} class={featureImageDarkUrl ? "dark:hidden" : ""} />
          {featureImageDarkUrl && <img src={featureImageDarkUrl} alt={featureImageAlt} class="hidden dark:block" />}
        </>
      ) : (
        <>
          <Picture
            class={`block w-full aspect-3/2 object-cover${resolvedSrcDark ? " dark:hidden" : ""}`}
            src={resolvedSrc as any}
            alt={featureImageAlt}
            width={600}
            height={400}
          />
          {resolvedSrcDark && (
            <Picture
              class="hidden dark:block w-full aspect-3/2 object-cover"
              src={resolvedSrcDark as any}
              alt={featureImageAlt}
              width={600}
              height={400}
            />
          )}
        </>
      )
    }
  </div>
  <div class="flex-1 bg-gray-100 p-6 flex flex-col justify-between dark:bg-slate-600">
    <div class="flex-1">
      <div class="flex flex-wrap gap-1">
        {categories.map((category) => (
          <a
            href={getCategoryUrl(category)}
            class="relative z-10 text-xs font-mono px-2 py-0.5 rounded-full border border-indigo-400 text-indigo-600 hover:border-indigo-600 dark:border-cyan-500 dark:text-cyan-300 dark:hover:border-cyan-300"
          >
            {category}
          </a>
        ))}
      </div>
      <a href={`/blog/${post.id}`} class="block mt-2 after:absolute after:inset-0">
        <p class="text-xl font-semibold text-gray-900 dark:text-white">
          {post.data.title}
        </p>
      </a>
    </div>
    <div class="mt-6 flex items-center">
      {
        authorImage && (
          <div class="shrink-0">
            <a href={`/blog/author/${author?.id}`} class="relative z-10">
              <span class="sr-only">{post.data.author}</span>
              <img
                class="h-10 w-10 rounded-full"
                src={authorImage}
                alt={`${post.data.author} avatar`}
              />
            </a>
          </div>
        )
      }
      <div class={authorImage ? `ml-3` : ``}>
        <p class="text-sm font-medium text-gray-900 dark:text-white">
          <a href={`/blog/author/${author?.id}`} class="relative z-10 hover:underline">
            {post.data.author}
          </a>
        </p>
        <div class="flex space-x-1 text-sm text-gray-600 dark:text-gray-300">
          <time datetime={post.data.pubDate.toISOString()}
            >{formatDate(post.data.pubDate.toISOString())}</time
          >
          <span aria-hidden="true"> &middot;</span>
          <span> {remarkPluginFrontmatter.minutesRead}</span>
        </div>
      </div>
    </div>
  </div>
</div>
