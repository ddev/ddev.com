---
import { marked } from "marked"
import { Picture } from 'astro:assets'
import type { ImageMetadata } from 'astro'

export interface Props {
  src: string
  srcDark?: string
  alt: string
  caption?: string
  credit?: string
  shadow?: boolean
}

const { src, srcDark, alt, caption = "", credit, shadow = false } = Astro.props

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/public/img/**/*.{png,jpg,jpeg,webp,gif}'
)
const resolveImage = async (path: string) => {
  const key = `/public${path}`
  return images[key] ? (await images[key]()).default : path
}
const resolvedSrc = await resolveImage(src)
const resolvedSrcDark = srcDark ? await resolveImage(srcDark) : null
---

<figure class={`w-full mx-auto mb-24 z-10 px-6 lg:px-0`}>
  {
    src.includes(".svg") ? (
      <>
        <img src={src} alt={alt} class={srcDark ? "dark:hidden" : ""} />
        {srcDark && <img src={srcDark} alt={alt} class="hidden dark:block" />}
      </>
    ) : (
      <>
        <div class={`block rounded-lg overflow-hidden${shadow ? " shadow-xl" : ""}${resolvedSrcDark ? " dark:hidden" : ""}`}>
          <Picture
            class="block w-full h-auto rounded-lg"
            src={resolvedSrc as any}
            alt={alt}
            width={900}
            height={500}
          />
        </div>
        {resolvedSrcDark && (
          <div class={`hidden dark:block rounded-lg overflow-hidden${shadow ? " shadow-xl" : ""}`}>
            <Picture
              class="block w-full h-auto rounded-lg"
              src={resolvedSrcDark as any}
              alt={alt}
              width={900}
              height={500}
            />
          </div>
        )}
      </>
    )
  }
  {
    (caption || credit) && (
      <figcaption class="text-sm font-mono mt-4 dark:text-slate-400">
        {caption && <span set:html={marked.parseInline(caption)} />}
        {credit && (
          <span class="text-gray-500 dark:text-slate-400">
            {caption && <span aria-hidden="true"> </span>}
            <span set:html={`${marked.parseInline(credit)}`} />
          </span>
        )}
      </figcaption>
    )
  }
</figure>
