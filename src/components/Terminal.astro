---
/**
 * This is a visual wrapper that puts simple terminal GUI around a code block
 * to help convey that it’s depicting a terminal session and not code.
 * FIX: Uses the <Code /> component to apply Shiki highlighting and transformers (like the copy button).
 */

import {
  XMarkIcon,
  MinusIcon,
  StopIcon,
} from "@heroicons/react/24/outline/index.js"
import { Code } from "astro/components" // Keep this import

// 1. Import the transformer here!
import { addCopyButton } from 'shiki-transformer-copy-button';

export interface Props {
  code: string
  codeTheme?: string
  type?:
    | "default"
    | "powershell"
    | "powershell-ubuntu"
    | "admin-powershell"
    | "windows-terminal"
    | "ubuntu"
  // Added a language prop for Shiki, defaults to 'bash'
  lang?: 'bash' | 'sh' | 'powershell' | 'text' 
}

// Destructure props, adding a default for lang
const { code, codeTheme = "nord", type = "default", lang = "bash" } = Astro.props

const promptSymbols = {
  default: '→',
  powershell: '>',
  "powershell-ubuntu": '$',
  "admin-powershell": '>',
  "windows-terminal": '>',
  ubuntu: '$',
}

const promptSymbol = promptSymbols[type];

/**
 * Strips the prompt symbol from the beginning of each line so the raw code
 * can be passed to Shiki, preventing the symbol from being highlighted incorrectly.
 * @returns The code with the prompt symbol removed from the start of each line.
 */
const stripPromptSymbol = (code: string, symbol: string) => {
  // Escape special regex characters like $
  let searchSymbol = (symbol === '$') ? '\\$' : symbol;
  
  // Regex to find the symbol at the start of a line (or start of string), globally
  const search = new RegExp(`^${searchSymbol} `, "gm")
  return code.replaceAll(search, "")
}

// The raw code block to be highlighted by Shiki
const rawCode = stripPromptSymbol(String(code), promptSymbol);
// Replace the line above with the original code, including prompts:
// const rawCode = String(code);


// 2. Define the transformers array for this component
const componentTransformers = [
    // Call the function here
    addCopyButton()
];
---
---

<div class="terminal-wrapper" data-prompt={promptSymbol}>
  <div class={`top-bar flex p-3 space-x-2 rounded-t-lg ${type}`}>
    {(type == "default" || type == "ubuntu") && (
      <div class="block rounded-full bg-slate-500 w-3 h-3"></div>
      <div class="block rounded-full bg-slate-500 w-3 h-3"></div>
      <div class="block rounded-full bg-slate-500 w-3 h-3"></div>
    )}
    {type == "powershell" && (
      <img src="/logos/powershell.svg" alt="" class="block w-3 h-3 m-0 self-start" />
      <div class="flex space-x-2">
        <div class="block w-3 h-3 items-end"><MinusIcon /></div>
        <div class="block w-3 h-3 items-end"><StopIcon /></div>
        <div class="block w-3 h-3 items-end"><XMarkIcon /></div>
      </div>
    )}
    {type == "powershell-ubuntu" && (
      <img src="/logos/tux.svg" alt="" class="block w-3 h-3 m-0 self-start" />
      <div class="flex space-x-2">
        <div class="block w-3 h-3 items-end"><MinusIcon /></div>
        <div class="block w-3 h-3 items-end"><StopIcon /></div>
        <div class="block w-3 h-3 items-end"><XMarkIcon /></div>
      </div>
    )}
  </div>
  <div class="terminal-code-container my-0">
    <Code code={rawCode} lang={lang} theme={codeTheme} transformers={componentTransformers} />
  </div>
</div>
